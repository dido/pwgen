#!/usr/bin/env ruby
# Generate a password by rolling dice
require 'pwgen/xrandom'
  
rng = PWGen::XRandom.new(0)
matrix = File.open(ARGV[0]) {|fp| eval(fp.read) }
pwl = ARGV[1].to_i
ncaps = (ARGV[2].to_s =~ /^[0-9]+$/) ? ARGV[2].to_i : rng.randnum(pwl/4) + 1
nums = (ARGV[3].nil?) ? 0 : ARGV[3].to_i
depth = matrix[:start].keys.inject(0) {|x,y| (y.length > x) ? y.length : x }
state = :start
output = ""
while output.length < pwl do
  p state
  sum = 0
  nextstate = nil
  state = :start if matrix[state].nil?
  smax = matrix[state].values.sum
  p smax
  ranno = rng.randnum(smax)
  p rng.ebits
  matrix[state].each_pair do |k,v|
    sum += v
    if sum >= ranno
      nextstate = k
      break
    end
  end
  if nextstate.nil?
    state = :start
  else
    output << nextstate
    state = nextstate
  end
end

output = output[0,pwl]
choices = (0..output.length).to_a
capletters = []
ncaps.times do
  choice = rng.randnum(choices.length-1)
  capletters << choices[choice]
  choices.delete(choices[choice])
end
capletters.each { |choice| output[choice] = output[choice].capitalize }
nums.times do
  pos = rng.randnum(output.length)
  num = [rng.randnum(10) + 0x30].pack("c")
  output[pos] = num
end
puts "Password: #{output}"
puts "Entropy: #{rng.randombits}"

